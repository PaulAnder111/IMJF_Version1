{% extends 'utilisateurs/base.html' %}
{% load static %}

{% block title %}Gestion des √âl√®ves - IMJF{% endblock %}

{% block content %}

<!-- Messages Block -->
{% include "messages_block.html" %}

<!-- SECTION HEADER AVEC GRADIENT (GRIS FONSE ‚Üí OR) -->
<div class="bg-gradient-to-r from-gray-800 to-amber-500 py-4 px-3 sm:px-6 text-white shadow-md mb-6 rounded-lg">
  <div class="max-w-7xl mx-auto flex flex-col sm:flex-row justify-between items-center gap-2">
    <div class="text-center sm:text-left">
      <h1 class="text-2xl font-bold mb-1">Gestion des √âl√®ves</h1>
      <p class="text-white/80 text-sm">G√©rez facilement tous les √©l√®ves de l'√©tablissement</p>
    </div>
    
    <!-- Bouton √âl√®ves Archiv√©s -->
    <div class="flex flex-col sm:flex-row gap-2">
      <a href="{% url 'eleves:eleve_archives' %}"
         class="inline-flex items-center px-4 py-2 bg-white/20 text-white font-semibold rounded-lg shadow-md hover:bg-white/30 transform hover:scale-105 transition-all duration-300 ease-in-out text-sm border border-white/30">
        <i class="fas fa-archive mr-2 text-sm"></i> √âl√®ves Archiv√©s
      </a>
      
      <!-- Bouton Ajouter √âl√®ve - Cache pour ARCHIVE -->
      {% if request.user.role != 'archives' %}
      <a href="{% url 'eleves:add_eleves' %}"
         class="inline-flex items-center px-4 py-2 bg-white text-amber-600 font-semibold rounded-lg shadow-md hover:shadow-lg hover:bg-amber-50 transform hover:scale-105 transition-all duration-300 ease-in-out text-sm">
        <i class="fas fa-plus-circle mr-2 text-sm"></i> Ajouter √âl√®ve
      </a>
      {% endif %}
    </div>
  </div>
</div>

<!-- Statistiques avec d√©grad√©s -->
<div class="grid grid-cols-1 sm:grid-cols-4 gap-4 mb-6">
  <div class="bg-gradient-to-r from-gray-700 to-amber-500 text-white p-4 rounded-lg shadow flex flex-col items-center">
    <p class="text-sm opacity-90">Total √âl√®ves</p>
    <p class="text-2xl font-bold">{{ total_eleves|default:"0" }}</p>
  </div>
  <div class="bg-gradient-to-r from-green-400 to-green-600 text-white p-4 rounded-lg shadow flex flex-col items-center">
    <p class="text-sm opacity-90">Actifs</p>
    <p class="text-2xl font-bold">{{ eleves_actifs|default:"0" }}</p>
  </div>
  <div class="bg-gradient-to-r from-yellow-400 to-yellow-600 text-white p-4 rounded-lg shadow flex flex-col items-center">
    <p class="text-sm opacity-90">Suspendus</p>
    <p class="text-2xl font-bold">{{ eleves_suspendus|default:"0" }}</p>
  </div>
  <div class="bg-gradient-to-r from-red-400 to-red-600 text-white p-4 rounded-lg shadow flex flex-col items-center">
    <p class="text-sm opacity-90">Radi√©s</p>
    <p class="text-2xl font-bold">{{ eleves_radies|default:"0" }}</p>
  </div>
</div>

<!-- üîç Bar de recherche et filtres -->
<div class="bg-white rounded-2xl shadow-lg p-4 sm:p-6 mb-6 border border-yellow-200">
  <form method="GET" action="" class="flex flex-col lg:flex-row gap-3 sm:gap-4">
    <!-- Barre de recherche automatique -->
    <div class="flex-1 relative">
      <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
        <i class="fas fa-search text-gray-400 text-sm"></i>
      </div>
      <input 
        type="text" 
        name="search" 
        id="searchInput"
        value="{{ request.GET.search }}"
        placeholder="Rechercher par nom, pr√©nom, matricule..." 
        class="w-full pl-10 pr-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent bg-white text-gray-900 text-sm"
      >
    </div>

    <!-- Filtre par statut -->
    <div class="relative">
      <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
        <i class="fas fa-filter text-gray-400 text-sm"></i>
      </div>
      <select 
        name="statut" 
        id="statutSelect"
        class="w-full lg:w-40 pl-10 pr-8 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent bg-white text-gray-900 text-sm appearance-none cursor-pointer"
      >
        <option value="">Tous les statuts</option>
        <option value="actif" {% if request.GET.statut == 'actif' %}selected{% endif %}>Actif</option>
        <option value="suspendu" {% if request.GET.statut == 'suspendu' %}selected{% endif %}>Suspendu</option>
        <option value="radi√©" {% if request.GET.statut == 'radi√©' %}selected{% endif %}>Radi√©</option>
      </select>
      <div class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
        <i class="fas fa-chevron-down text-gray-400 text-sm"></i>
      </div>
    </div>

    <!-- Filtre par classe -->
    <div class="relative">
      <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
        <i class="fas fa-school text-gray-400 text-sm"></i>
      </div>
      <select 
        name="classe" 
        id="classeSelect"
        class="w-full lg:w-48 pl-10 pr-8 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent bg-white text-gray-900 text-sm appearance-none cursor-pointer"
      >
        <option value="">Toutes les classes</option>
        {% for classe in classes %}
          <option value="{{ classe.id }}" {% if request.GET.classe == classe.id|stringformat:"s" %}selected{% endif %}>
            {{ classe.nom_classe }}
          </option>
        {% endfor %}
      </select>
      <div class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
        <i class="fas fa-chevron-down text-gray-400 text-sm"></i>
      </div>
    </div>

    <!-- Bouton reset -->
    {% if request.GET.search or request.GET.statut or request.GET.classe %}
    <a href="{% url 'eleves:eleve_list' %}" 
       class="inline-flex items-center justify-center px-4 py-3 bg-gray-500 hover:bg-gray-600 text-white font-medium rounded-lg transition shadow text-sm">
      <i class="fas fa-redo mr-2 text-sm"></i> R√©initialiser
    </a>
    {% endif %}
  </form>
</div>

<!-- TABLEAU DES √âL√àVES -->
<div class="bg-white rounded-2xl shadow-lg overflow-hidden border border-yellow-200">
  <div class="overflow-x-auto">
    <table class="w-full min-w-full" id="eleves-table">
      <thead class="bg-gradient-to-r from-amber-100 to-yellow-100 border-b border-yellow-300">
        <tr>
          <th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Matricule</th>
          <th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Nom & Pr√©nom</th>
          <th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Sexe</th>
          <th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Classe</th>
          <th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Date Naiss.</th>
          <th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Statut</th>
          <th class="px-4 py-3 text-center text-xs font-bold text-gray-700 uppercase tracking-wider">Actions</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-200 bg-white">
        {% for eleve in eleves %}
        <tr id="eleve-row-{{ eleve.id }}" class="hover:bg-amber-50/50 transition-all duration-200 ease-in-out">
          <td class="px-4 py-3 text-sm font-medium text-gray-900">
            <span class="font-mono bg-gray-100 px-2 py-1 rounded-full text-xs">
              {{ eleve.matricule }}
            </span>
          </td>
          <td class="px-4 py-3">
            <div class="flex items-center">
              <div class="flex-shrink-0 h-10 w-10">
                {% if eleve.photo and eleve.photo.name != 'eleves/photos/default_avatar.png' %}
                  <img class="h-10 w-10 rounded-full object-cover border-2 border-yellow-500" src="{{ eleve.photo.url }}" alt="">
                {% else %}
                  <div class="h-10 w-10 rounded-full bg-gradient-to-br 
                      {% if eleve.sexe == 'M' %}from-blue-500 to-blue-600{% else %}from-pink-500 to-pink-600{% endif %} 
                      flex items-center justify-center text-white font-bold text-sm border-2 
                      {% if eleve.sexe == 'M' %}border-blue-400{% else %}border-pink-400{% endif %}">
                    {{ eleve.prenom.0|upper }}{{ eleve.nom.0|upper }}
                  </div>
                {% endif %}
              </div>
              <div class="ml-3">
                <div class="text-sm font-medium text-gray-900">
                  {{ eleve.nom|upper }} {{ eleve.prenom|title }}
                </div>
                <div class="text-xs text-gray-500">
                  <i class="fas fa-phone text-green-500 mr-1"></i>{{ eleve.telephone_tuteur|default:"N/A" }}
                </div>
              </div>
            </div>
          </td>
          <td class="px-4 py-3 text-sm text-gray-800">
            {% if eleve.sexe == 'M' %}
              <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-blue-100 text-blue-800 border border-blue-200 shadow-sm">
                <i class="fas fa-mars mr-1 text-xs"></i> Masculin
              </span>
            {% else %}
              <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-pink-100 text-pink-800 border border-pink-200 shadow-sm">
                <i class="fas fa-venus mr-1 text-xs"></i> F√©minin
              </span>
            {% endif %}
          </td>
          <td class="px-4 py-3 text-sm text-gray-800">
            {% if eleve.classe_actuelle %}
              <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-indigo-100 text-indigo-800 border border-indigo-200 shadow-sm">
                <i class="fas fa-chalkboard mr-1 text-xs"></i>{{ eleve.classe_actuelle.nom_classe }}
              </span>
            {% else %}
              <span class="text-gray-400 italic text-sm">Non affect√©</span>
            {% endif %}
          </td>
          <td class="px-4 py-3 text-sm text-gray-800">
            <i class="far fa-calendar text-blue-500 mr-1"></i>
            {{ eleve.date_naissance|date:"d/m/Y"|default:"‚Äî" }}
          </td>
          <td class="px-4 py-3 text-sm">
            {% if eleve.statut == 'actif' %}
              <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800 border border-green-200 shadow-sm">
                <span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>
                Actif
              </span>
            {% elif eleve.statut == 'suspendu' %}
              <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-800 border border-yellow-200 shadow-sm">
                <span class="w-2 h-2 bg-yellow-500 rounded-full mr-2"></span>
                Suspendu
              </span>
            {% elif eleve.statut == 'radi√©' %}
              <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-800 border border-red-200 shadow-sm">
                <span class="w-2 h-2 bg-red-500 rounded-full mr-2"></span>
                Radi√©
              </span>
            {% else %}
              <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-gray-100 text-gray-800 border border-gray-200 shadow-sm">
                <span class="w-2 h-2 bg-gray-500 rounded-full mr-2"></span>
                {{ eleve.statut|title }}
              </span>
            {% endif %}
          </td>
          <td class="px-4 py-3">
            <div class="flex items-center justify-center gap-2">
              <!-- Bouton Voir - Visible pour tous -->
              <a href="{% url 'eleves:eleves_detail' eleve.id %}" 
                 class="p-2 bg-gradient-to-br from-green-400 to-green-600 text-white rounded-lg hover:from-green-500 hover:to-green-700 hover:scale-110 transform transition-all duration-200 shadow hover:shadow-md" 
                 title="Voir d√©tails">
                <i class="fas fa-eye text-sm"></i>
              </a>

              <!-- Bouton Modifier - Cach√© pour archives -->
              {% if request.user.role != 'archives' %}
              <a href="{% url 'eleves:eleve_update' eleve.id %}" 
                 class="p-2 bg-gradient-to-br from-blue-400 to-blue-600 text-white rounded-lg hover:from-blue-500 hover:to-blue-700 hover:scale-110 transform transition-all duration-200 shadow hover:shadow-md" 
                 title="Modifier">
                <i class="fas fa-edit text-sm"></i>
              </a>
              {% endif %}

              <!-- Bouton Archiver - Visible seulement pour admin et directeur -->
              {% if request.user.role == 'admin' or request.user.role == 'directeur' %}
              <form action="{% url 'eleves:eleve_archiver' eleve.id %}" method="POST" class="inline">
                {% csrf_token %}
                <button type="submit"
                   onclick="return confirm('Voulez-vous vraiment archiver cet √©l√®ve?')"
                   class="p-2 bg-gradient-to-br from-red-400 to-red-600 text-white rounded-lg hover:from-red-500 hover:to-red-700 hover:scale-110 transform transition-all duration-200 shadow hover:shadow-md" 
                   title="Archiver">
                  <i class="fas fa-archive text-sm"></i>
                </button>
              </form>
              {% endif %}
            </div>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="7" class="px-6 py-8 text-center text-gray-500">
            <div class="flex flex-col items-center justify-center">
              <i class="fas fa-user-graduate text-4xl text-gray-300 mb-3"></i>
              <p class="text-lg font-medium text-gray-400">Aucun √©l√®ve trouv√©</p>
              {% if request.GET.search or request.GET.statut or request.GET.classe %}
                <p class="text-sm text-gray-500 mt-1">Aucun r√©sultat ne correspond √† votre recherche</p>
              {% else %}
                <p class="text-sm text-gray-500 mt-1">La liste des √©l√®ves est vide pour le moment</p>
              {% endif %}
              
              <div class="flex flex-col sm:flex-row gap-2 mt-3">
                <a href="{% url 'eleves:eleve_list' %}" 
                   class="inline-flex items-center justify-center bg-gray-500 hover:bg-gray-600 text-white font-medium px-4 py-2 rounded-lg transition shadow text-sm">
                  <i class="fas fa-redo mr-2"></i> Actualiser
                </a>
                
                <!-- Bouton Ajouter dans √©tat vide - Cache pour SECRETAIRE et ARCHIVE -->
                {% if request.user.role == 'admin' or request.user.role == 'directeur' %}
                <a href="{% url 'eleves:add_eleves' %}"
                   class="inline-flex items-center justify-center bg-amber-600 hover:bg-amber-700 text-white font-medium px-4 py-2 rounded-lg shadow transform hover:scale-105 transition duration-300 text-sm">
                  <i class="fas fa-plus-circle mr-2"></i> Ajouter √âl√®ve
                </a>
                {% endif %}
              </div>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Pagination -->
{% if eleves.has_other_pages %}
<div class="mt-6 flex justify-center">
  <nav class="flex items-center space-x-2">
    {% if eleves.has_previous %}
    <a href="?page={{ eleves.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.statut %}&statut={{ request.GET.statut }}{% endif %}{% if request.GET.classe %}&classe={{ request.GET.classe }}{% endif %}" 
       class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 hover:text-gray-700 transition-colors">
      Pr√©c√©dent
    </a>
    {% endif %}

    {% for num in eleves.paginator.page_range %}
      {% if eleves.number == num %}
      <span class="px-3 py-2 text-sm font-medium text-amber-600 bg-amber-50 border border-amber-200 rounded-lg">{{ num }}</span>
      {% else %}
      <a href="?page={{ num }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.statut %}&statut={{ request.GET.statut }}{% endif %}{% if request.GET.classe %}&classe={{ request.GET.classe }}{% endif %}" 
         class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 hover:text-gray-700 transition-colors">
        {{ num }}
      </a>
      {% endif %}
    {% endfor %}

    {% if eleves.has_next %}
    <a href="?page={{ eleves.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.statut %}&statut={{ request.GET.statut }}{% endif %}{% if request.GET.classe %}&classe={{ request.GET.classe }}{% endif %}" 
       class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 hover:text-gray-700 transition-colors">
      Suivant
    </a>
    {% endif %}
  </nav>
</div>
{% endif %}

<!-- JavaScript pour recherche automatique -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Recherche automatique au typing
  let searchTimeout;
  const searchInput = document.getElementById('searchInput');
  const statutSelect = document.getElementById('statutSelect');
  const classeSelect = document.getElementById('classeSelect');

  if (searchInput) {
    searchInput.addEventListener('input', function() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        this.form.submit();
      }, 500);
    });
  }

  if (statutSelect) {
    statutSelect.addEventListener('change', function() {
      this.form.submit();
    });
  }

  if (classeSelect) {
    classeSelect.addEventListener('change', function() {
      this.form.submit();
    });
  }

  // Animation des cartes statistiques au scroll
  const observerOptions = {
    threshold: 0.1,
    rootMargin: '0px 0px -100px 0px'
  };

  const observer = new IntersectionObserver(function(entries) {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        entry.target.style.opacity = '0';
        entry.target.style.transform = 'translateY(20px)';
        setTimeout(() => {
          entry.target.style.transition = 'all 0.5s ease-out';
          entry.target.style.opacity = '1';
          entry.target.style.transform = 'translateY(0)';
        }, 100);
        observer.unobserve(entry.target);
      }
    });
  }, observerOptions);

  document.querySelectorAll('.grid > div').forEach(card => {
    observer.observe(card);
  });
});

// Animation pour les boutons
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

tr {
  animation: fadeIn 0.3s ease-out;
}
</script>

<!-- Style responsive suppl√©mentaire -->
<style>
@media (max-width: 640px) {
  #eleves-table th:nth-child(3),
  #eleves-table td:nth-child(3),
  #eleves-table th:nth-child(5),
  #eleves-table td:nth-child(5) {
    display: none;
  }
  
  .px-4 {
    padding-left: 0.5rem;
    padding-right: 0.5rem;
  }
  
  .py-3 {
    padding-top: 0.5rem;
    padding-bottom: 0.5rem;
  }
  
  .grid-cols-4 {
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }
}
</style>

{% endblock %}