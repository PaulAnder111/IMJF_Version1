{% extends 'utilisateurs/base.html' %}
{% load static %}

{% block title %}Ajouter une Classe - SYGEE{% endblock %}

{% block content %}
{# messages handled globally by base.html #}
<div class="container mx-auto px-3 sm:px-4 max-w-6xl">
    <!-- En-tête compact -->
    <div class="bg-gradient-to-r from-gray-600 via-gray-500 to-gray-600 rounded-lg shadow-md p-3 sm:p-4 mb-4 border border-yellow-300/20">
        <div class="flex flex-col sm:flex-row items-center justify-between gap-2">
            <div class="flex items-center space-x-2">
                <div class="bg-gradient-to-br from-yellow-400 to-yellow-500 p-2 rounded-lg">
                    <i class="fas fa-chalkboard text-white text-sm sm:text-base"></i>
                </div>
                <div class="text-center sm:text-left">
                    <h1 class="text-lg sm:text-xl font-bold text-white">Ajouter une Classe</h1>
                    <p class="text-gray-200 text-xs">Créer une nouvelle classe dans le système</p>
                </div>
            </div>
            <a href="{% url 'classes:classe_list' %}" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-2 rounded-lg text-sm font-medium transition-all flex items-center space-x-2 w-full sm:w-auto justify-center">
                <i class="fas fa-arrow-left text-xs"></i>
                <span class="text-xs sm:text-sm">Retour</span>
            </a>
        </div>
    </div>

    <!-- Information Alert -->
    <div class="bg-blue-50 border-l-4 border-blue-500 p-3 rounded-lg mb-4">
        <div class="flex items-start">
            <i class="fas fa-info-circle text-blue-500 mr-2 mt-0.5"></i>
            <div>
                <p class="font-semibold text-blue-800 text-sm">Information importante</p>
                <p class="text-xs text-blue-700 mt-1">Les champs marqués d'un astérisque (<span class="text-red-500">*</span>) sont obligatoires.</p>
            </div>
        </div>
    </div>

    <!-- Form Section avec layout horizontal -->
    <div class="bg-white rounded-lg shadow-md border border-gray-200">
        <form method="POST" class="space-y-0" id="classeForm" novalidate>
            {% csrf_token %}
            
            <!-- Messages d'erreur globaux -->
            {% if form.non_field_errors %}
            <div class="bg-red-50 border-l-4 border-red-500 p-3 m-4 rounded-lg">
                <div class="flex items-center">
                    <i class="fas fa-exclamation-circle text-red-500 mr-2"></i>
                    <div>
                        <p class="font-semibold text-red-800 text-sm">Erreur dans le formulaire</p>
                        <p class="text-xs text-red-600 mt-1">{{ form.non_field_errors }}</p>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Grid Principal - 3 Colonnes -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 p-4">
                
                <!-- Colonne 1: Informations de Base -->
                <div class="space-y-3">
                    <div class="flex items-center mb-2">
                        <div class="bg-yellow-500 w-1 h-4 rounded mr-2"></div>
                        <h3 class="text-sm font-bold text-gray-700 flex items-center">
                            <i class="fas fa-info-circle text-yellow-500 mr-1 text-xs"></i>
                            Informations de Base
                        </h3>
                    </div>

                    <!-- Nom de la classe -->
                    <div class="space-y-1">
                        <label for="{{ form.nom.id_for_label }}" class="block text-xs font-semibold text-gray-600 flex items-center">
                            <i class="fas fa-signature text-yellow-500 mr-1 text-xs"></i>
                            Nom de la classe <span class="text-red-500 ml-1">*</span>
                        </label>
                        <input type="text" 
                               name="{{ form.nom.name }}" 
                               id="{{ form.nom.id_for_label }}"
                               value="{{ form.nom.value|default:'' }}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-yellow-500 text-sm"
                               placeholder="Ex: 6ème A"
                               required>
                        {% if form.nom.errors %}
                            <p class="mt-1 text-xs text-red-600 flex items-center">
                                <i class="fas fa-exclamation-circle text-red-500 mr-1 text-xs"></i>
                                {{ form.nom.errors.0 }}
                            </p>
                        {% endif %}
                    </div>

                    <!-- Niveau -->
                    <div class="space-y-1">
                        <label for="{{ form.niveau.id_for_label }}" class="block text-xs font-semibold text-gray-600 flex items-center">
                            <i class="fas fa-layer-group text-yellow-500 mr-1 text-xs"></i>
                            Niveau <span class="text-red-500 ml-1">*</span>
                        </label>
                        <select name="{{ form.niveau.name }}" 
                                id="{{ form.niveau.id_for_label }}"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-yellow-500 text-sm"
                                required>
                            <!-- placeholder removed; choose a niveau -->
                            {% for value, label in form.niveau.field.choices %}
                                {% if value %}
                                <option value="{{ value }}" {% if form.niveau.value == value %}selected{% endif %}>{{ label }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                        {% if form.niveau.errors %}
                            <p class="mt-1 text-xs text-red-600 flex items-center">
                                <i class="fas fa-exclamation-circle text-red-500 mr-1 text-xs"></i>
                                {{ form.niveau.errors.0 }}
                            </p>
                        {% endif %}
                    </div>
                </div>

                <!-- Colonne 2: Configuration -->
                <div class="space-y-3">
                    <div class="flex items-center mb-2">
                        <div class="bg-blue-500 w-1 h-4 rounded mr-2"></div>
                        <h3 class="text-sm font-bold text-gray-700 flex items-center">
                            <i class="fas fa-cogs text-blue-500 mr-1 text-xs"></i>
                            Configuration
                        </h3>
                    </div>

                    <!-- Capacité maximale -->
                    <div class="space-y-1">
                        <label for="{{ form.capacite_max.id_for_label }}" class="block text-xs font-semibold text-gray-600 flex items-center">
                            <i class="fas fa-users text-yellow-500 mr-1 text-xs"></i>
                            Capacité maximale <span class="text-red-500 ml-1">*</span>
                        </label>
                        <div class="relative">
                            <input type="number" 
                                   name="{{ form.capacite_max.name }}" 
                                   id="{{ form.capacite_max.id_for_label }}"
                                   value="{{ form.capacite_max.value|default:'30' }}"
                                   min="1" 
                                   max="50"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-yellow-500 text-sm"
                                   required>
                        </div>
                        {% if form.capacite_max.errors %}
                            <p class="mt-1 text-xs text-red-600 flex items-center">
                                <i class="fas fa-exclamation-circle text-red-500 mr-1 text-xs"></i>
                                {{ form.capacite_max.errors.0 }}
                            </p>
                        {% else %}
                            <p class="text-xs text-gray-500 mt-1">Entre 1 et 50 élèves</p>
                        {% endif %}
                    </div>

                    <!-- Enseignant principal -->
                    <div class="space-y-1">
                        <label for="{{ form.enseignant_principal.id_for_label }}" class="block text-xs font-semibold text-gray-600 flex items-center">
                            <i class="fas fa-user-tie text-yellow-500 mr-1 text-xs"></i>
                            Enseignant principal <span class="text-red-500 ml-1">*</span>
                        </label>
                        <select name="{{ form.enseignant_principal.name }}" 
                                id="{{ form.enseignant_principal.id_for_label }}"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-yellow-500 text-sm"
                                required>
                            <!-- placeholder removed; choose an enseignant -->
                            {% for enseignant in form.enseignant_principal.field.queryset %}
                            <option value="{{ enseignant.id }}" {% if form.enseignant_principal.value == enseignant.id|stringformat:"s" %}selected{% endif %}>
                                {{ enseignant.get_full_name }}
                            </option>
                            {% endfor %}
                        </select>
                        {% if form.enseignant_principal.errors %}
                            <p class="mt-1 text-xs text-red-600 flex items-center">
                                <i class="fas fa-exclamation-circle text-red-500 mr-1 text-xs"></i>
                                {{ form.enseignant_principal.errors.0 }}
                            </p>
                        {% endif %}
                    </div>
                </div>

                <!-- Colonne 3: Description & Matières -->
                <div class="space-y-3">
                    <div class="flex items-center mb-2">
                        <div class="bg-purple-500 w-1 h-4 rounded mr-2"></div>
                        <h3 class="text-sm font-bold text-gray-700 flex items-center">
                            <i class="fas fa-book text-purple-500 mr-1 text-xs"></i>
                            Description & Matières
                        </h3>
                    </div>

                    <!-- Description -->
                    <div class="space-y-1">
                        <label for="{{ form.description.id_for_label }}" class="block text-xs font-semibold text-gray-600 flex items-center">
                            <i class="fas fa-file-alt text-yellow-500 mr-1 text-xs"></i>
                            Description
                        </label>
                        <textarea name="{{ form.description.name }}" 
                                  id="{{ form.description.id_for_label }}"
                                  rows="3"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-yellow-500 text-sm resize-vertical"
                                  placeholder="Description optionnelle de la classe...">{{ form.description.value|default:'' }}</textarea>
                        {% if form.description.errors %}
                            <p class="mt-1 text-xs text-red-600 flex items-center">
                                <i class="fas fa-exclamation-circle text-red-500 mr-1 text-xs"></i>
                                {{ form.description.errors.0 }}
                            </p>
                        {% endif %}
                    </div>

                    <!-- Matières enseignées -->
                    {% if form.matieres %}
                    <div class="space-y-1">
                        <label class="block text-xs font-semibold text-gray-600 flex items-center">
                            <i class="fas fa-book-open text-yellow-500 mr-1 text-xs"></i>
                            Matières enseignées
                        </label>
                        <div class="max-h-32 overflow-y-auto border border-gray-300 rounded-lg p-2">
                            {% for checkbox in form.matieres %}
                            <div class="flex items-center space-x-2 py-1 px-2 hover:bg-gray-50 rounded">
                                <input type="checkbox" 
                                       name="{{ form.matieres.name }}" 
                                       value="{{ checkbox.data.value }}"
                                       id="matiere_{{ checkbox.data.value }}"
                                       {% if checkbox.data.selected %}checked{% endif %}
                                       class="w-3 h-3 text-yellow-500 border-gray-300 rounded focus:ring-yellow-500">
                                <label for="matiere_{{ checkbox.data.value }}" class="text-xs text-gray-700 cursor-pointer">
                                    {{ checkbox.data.label }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                        {% if form.matieres.errors %}
                            <p class="mt-1 text-xs text-red-600 flex items-center">
                                <i class="fas fa-exclamation-circle text-red-500 mr-1 text-xs"></i>
                                {{ form.matieres.errors.0 }}
                            </p>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Buttons Section -->
            <div class="bg-gray-50 p-4 border-t border-gray-200 rounded-b-lg">
                <div class="flex flex-col sm:flex-row items-center justify-between gap-3">
                    <a href="{% url 'classes:classe_list' %}" 
                        class="w-full sm:w-auto px-4 py-2 bg-gray-400 hover:bg-gray-500 text-white text-sm font-medium rounded-lg transition-all flex items-center justify-center space-x-2 order-2 sm:order-1">
                        <i class="fas fa-times text-xs"></i>
                        <span>Annuler</span>
                    </a>
                    
                    <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto order-1 sm:order-2">
                        <button type="reset" 
                            class="w-full sm:w-auto px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white text-sm font-medium rounded-lg transition-all flex items-center justify-center space-x-2">
                            <i class="fas fa-redo text-xs"></i>
                            <span>Réinitialiser</span>
                        </button>
                        
                        <button type="submit" 
                            class="w-full sm:w-auto px-6 py-2 bg-gradient-to-r from-yellow-500 to-yellow-600 hover:from-yellow-600 hover:to-yellow-700 text-white text-sm font-bold rounded-lg transition-all flex items-center justify-center space-x-2 shadow-md">
                            <i class="fas fa-check-circle text-xs"></i>
                            <span>Enregistrer</span>
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Style CSS pour le layout horizontal -->
<style>
    /* Style de base pour tous les champs */
    input, select, textarea {
        @apply w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-yellow-500 text-sm transition-all duration-200;
    }

    /* Style pour les textareas */
    textarea {
        resize: vertical;
        min-height: 80px;
    }

    /* Style pour les selects */
    select {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 0.5rem center;
        background-repeat: no-repeat;
        background-size: 1em 1em;
        padding-right: 2rem;
    }

    /* Style pour les checkboxes */
    input[type="checkbox"] {
        @apply rounded border-gray-300 text-yellow-500 focus:ring-yellow-500;
    }

    /* Layout 3 colonnes optimisé */
    @media (min-width: 1024px) {
        .lg\:grid-cols-3 {
            grid-template-columns: repeat(3, minmax(0, 1fr));
        }
    }

    /* Responsivité pour tablettes */
    @media (max-width: 1024px) and (min-width: 768px) {
        .lg\:grid-cols-3 {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }
    }

    /* Responsivité pour mobiles */
    @media (max-width: 767px) {
        .lg\:grid-cols-3 {
            grid-template-columns: 1fr;
        }
        
        .container {
            padding-left: 0.5rem;
            padding-right: 0.5rem;
        }
        
        input, select, textarea {
            font-size: 16px;
            min-height: 44px;
        }
        
        .p-4 {
            padding: 1rem;
        }
    }

    /* Très petits écrans */
    @media (max-width: 480px) {
        .text-lg {
            font-size: 1.125rem;
        }
        
        .space-y-1 > * + * {
            margin-top: 0.25rem;
        }
        
        .space-y-3 > * + * {
            margin-top: 0.75rem;
        }
    }

    /* Animations au focus */
    input:focus, select:focus, textarea:focus {
        transform: translateY(-1px);
    }

    /* Empêcher le zoom sur iOS */
    @media (max-width: 480px) {
        input[type="text"],
        input[type="number"],
        select,
        textarea {
            font-size: 16px;
        }
    }

    /* Style pour les erreurs */
    .border-error {
        @apply border-red-500 bg-red-50;
    }

    /* Scrollbar personnalisé pour les matières */
    .max-h-32::-webkit-scrollbar {
        width: 4px;
    }
    
    .max-h-32::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }
    
    .max-h-32::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 10px;
    }
    
    .max-h-32::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }
</style>

<!-- Scripts optimisés -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('classeForm');
    
    // Validation en temps réel
    const requiredFields = form.querySelectorAll('[required]');
    
    requiredFields.forEach(field => {
        field.addEventListener('blur', function() {
            if (!this.value.trim()) {
                this.classList.add('border-red-500', 'bg-red-50');
            } else {
                this.classList.remove('border-red-500', 'bg-red-50');
            }
        });

        field.addEventListener('input', function() {
            if (this.value.trim()) {
                this.classList.remove('border-red-500', 'bg-red-50');
            }
        });
    });

    // Validation avant soumission
    if (form) {
        form.addEventListener('submit', function(e) {
            let isValid = true;
            const emptyFields = [];

            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    isValid = false;
                    emptyFields.push(field.previousElementSibling?.textContent?.trim() || 'Champ requis');
                    field.classList.add('border-red-500', 'bg-red-50');
                }
            });

            if (!isValid) {
                e.preventDefault();
                alert('Veuillez remplir tous les champs obligatoires.');
                
                // Scroll vers le premier champ vide
                const firstEmpty = document.querySelector('.border-red-500');
                if (firstEmpty) {
                    firstEmpty.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstEmpty.focus();
                }
            }
        });
    }

    // Confirmation avant réinitialisation
    const resetButton = document.querySelector('button[type="reset"]');
    if (resetButton) {
        resetButton.addEventListener('click', function(e) {
            if (!confirm('Êtes-vous sûr de vouloir réinitialiser tous les champs du formulaire ?')) {
                e.preventDefault();
            }
        });
    }

    // Optimisation mobile pour les selects
    if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
        const selects = document.querySelectorAll('select');
        selects.forEach(select => {
            select.addEventListener('touchstart', function() {
                this.style.fontSize = '16px';
            });
        });
    }

    // Amélioration UX pour les nombres
    const numberInput = document.querySelector('input[type="number"]');
    if (numberInput) {
        numberInput.addEventListener('input', function(e) {
            let value = parseInt(e.target.value);
            if (value < 1) e.target.value = 1;
            if (value > 50) e.target.value = 50;
        });
    }
});
</script>
{% endblock %}